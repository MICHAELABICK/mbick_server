---
- hosts: all
  become: yes
  pre_tasks:
    - name: Apt update
      apt:
        update_cache: yes

    - name: Install pip3
      apt:
        name: python3-pip
        state: present
  roles:
    - { role: "nickjj.docker", tags: ["docker"] }
  handlers:
    - name: Run docker-compose
      shell: docker-compose up -d
      args:
        chdir: "{{ build_dir }}"

  tasks:
    - name: Install docker module
      pip:
        name: docker

    - name: Install docker-compose module
      pip:
        name: docker-compose

    - name: Create groups
      group:
        name: "{{ item.name }}"
        gid: "{{ item.id }}"
        state: present
      loop: "{{ ct_users }}"

    - name: Create users
      user:
        name: "{{ item.name }}"
        uid: "{{ item.id }}"
        groups: "[ '{{ item.name }}' ] + {{ item.groups | default([]) }}"
        # create_home: no
        system: yes
        state: present
      loop: "{{ ct_users }}"

    # - name: Create mount directory
    #   file:
    #     path: "{{ mount_dir }}"
    #     state: directory

    - name: Create mountpoints for containers
      file:
        path: "{{ mount_dir }}/{{ item.name }}"
        owner: "{{ item.owner }}"
        group: "{{ item.owner }}"
        state: directory
        mode: 0775
      loop: "{{ volumes|selectattr('type', 'equalto', 'local') }}"

    - name: Add Vagrant user to all container groups
      user:
        name: vagrant
        groups:
          - "{{ item.name }}"
        append: yes
      loop: "{{ ct_users }}"

    - name: Create build directory
      file:
        path: "{{ build_dir }}"
        state: directory
      tags:
        - mbick-docker

    # - name: Copy source files to build directory
    #   synchronize:
    #     src: ../src/
    #     dest: "{{ build_dir }}"
    #     recursive: yes
    #     delete: yes

    - name: Build docker-compose.yml
      template:
        src: "{{ src_dir }}/docker-compose.yml.j2"
        dest: "{{ build_dir }}/docker-compose.yml"
      notify:
        - "Run docker-compose"
      tags:
        - mbick-docker
