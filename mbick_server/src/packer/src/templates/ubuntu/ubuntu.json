{
  "variables": {
    "ansible_dir": null,
    "ansible_inventory_dir": null,
    "http_directory": "{{template_dir}}/http",
    "preseed": "preseed.cfg",
    "local_host_ip": null,

    "proxmox_api_host": null,
    "proxmox_api_url": null,
    "proxmox_user": null,
    "proxmox_password": null,

    "ubuntu_release": "bionic",
    "virtualbox_guest_os_type": "Ubuntu_64",
    "proxmox_iso_file": "vm-isos:iso/ubuntu-18.04.2-server-amd64.iso",
    "iso_url": "http://cdimage.ubuntu.com/releases/18.04/release/ubuntu-18.04.2-server-amd64.iso",
    "iso_checksum": "34416ff83179728d54583bf3f18d42d2",
    "iso_checksum_type": "md5",

    "cpus": "1",
    "cores": "2",
    "memory": "1024",
    "disk_size_MB": "20000",

    "ssh_fullname": "packer",
    "ssh_password": "packer",
    "ssh_username": "packer",

    "vm_name": "{{user `hostname`}}-{{timestamp}}",
    "hostname": "ubuntu-{{user `ubuntu_release`}}",
    "boot_command_prefix": "<esc><esc><enter><wait>",
    "boot_command_suffix": [
      "auto ",
      "console-setup/ask_detect=false ",
      "debconf/frontend=noninteractive ",
      "debian-installer={{ user `locale` }} ",
      "hostname={{ user `hostname` }} ",
      "fb=false ",
      "grub-installer/bootdev=/dev/sda<wait> ",
      "initrd=/install/initrd.gz ",
      "kbd-chooser/method=us ",
      "keyboard-configuration/modelcode=SKIP ",
      "keyboard-configuration/layout=USA ",
      "keyboard-configuration/variant=USA ",
      "locale={{ user `locale` }} ",
      "noapic ",
      "passwd/user-fullname={{ user `ssh_fullname` }} ",
      "passwd/user-password={{ user `ssh_password` }} ",
      "passwd/user-password-again={{ user `ssh_password` }} ",
      "passwd/username={{ user `ssh_username` }} ",
      "-- <enter>"
    ],
    "locale": "en_US"
  },
  "builders": [
    {
      "type": "proxmox",
      "proxmox_url": "{{user `proxmox_api_url`}}",
      "insecure_skip_tls_verify": true,
      "username": "{{user `proxmox_user`}}",
      "password": "{{user `proxmox_password`}}",

      "vm_name": "{{user `vm_name`}}",
      "node": "node1",
      "sockets": "{{user `cpus`}}",
      "cores": "{{user `cores`}}",
      "memory": "{{user `memory`}}",
      "os": "l26",
      "network_adapters": [
        {
          "model": "virtio",
          "bridge": "vmbr0"
        }
      ],
      "disks": [
        {
          "type": "scsi",
          "disk_size": "{{user `disk_size_MB`}}M",
          "storage_pool": "local-zfs",
          "storage_pool_type": "zfspool",
          "format": "raw"
        }
      ],
      "qemu_agent": true,

      "iso_file": "{{user `proxmox_iso_file`}}",
      "http_directory": "{{user `http_directory`}}",
      "boot_wait": "10s",
      "boot_command": [
        "{{ user `boot_command_prefix` }}",
        "/install/vmlinuz ",
        "preseed/url=http://{{user `local_host_ip`}}:{{ .HTTPPort }}/{{user `preseed`}} ",
        "{{user `boot_command_suffix`}}"
      ],

      "ssh_password": "{{ user `ssh_password` }}",
      "ssh_timeout": "15m",
      "ssh_username": "{{ user `ssh_username` }}",

      "unmount_iso": true,
      "template_description": "Ubuntu 18.04.02, generated on {{ isotime \"2006-01-02T15:04:05Z\" }}"
    },
    {
      "type": "virtualbox-iso",
      "output_directory": "output-{{ user `vm_name` }}-virtualbox-iso",

      "memory": "{{user `memory`}}",
      "disk_size": "{{user `disk_size_MB`}}",

      "guest_os_type": "{{user `virtualbox_guest_os_type`}}",
      "iso_url": "{{user `iso_url`}}",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",
      "http_directory":"{{user `http_directory`}}",
      "boot_command": [
        "{{ user `boot_command_prefix` }}",
        "/install/vmlinuz ",
        "preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/{{user `preseed`}} ",
        "{{user `boot_command_suffix`}}"
      ],
      "shutdown_command": "echo 'packer' | sudo -S shutdown -P now",

      "ssh_password": "{{ user `ssh_password` }}",
      "ssh_timeout": "15m",
      "ssh_username": "{{ user `ssh_username` }}"
    }
  ],
  "provisioners": [
    {
      "pause_before": "5s",
      "type": "ansible",
      "playbook_file": "{{user `ansible_dir`}}/bake_image.yml",
      "extra_arguments": [
        "-i",
        "{{user `ansible_inventory_dir`}}/group_inventory",
        "-i",
        "{{user `ansible_inventory_dir`}}/defaults",
        "-e",
        "ansible_become_password={{user `ssh_password`}}"
      ],
      "groups": [
        "proxmox_vm",
        "ubuntu_{{user `ubuntu_release`}}",
        "cloud_init"
      ],
      "user": "{{user `ssh_username`}}"
    }
  ],
  "post-processors": [
    {
      "keep_input_artifact": true,
      "type": "shell-local",
      "inline": [
          "{{template_dir}}/../../scripts/config-remote-proxmox-ci-drive root@{{user `proxmox_api_host`}} -n \"{{user `vm_name`}}\""
      ],
      "only": ["proxmox"]
    },
    {
      "keep_input_artifact": false,
      "output": "box/{{.Provider}}/{{user `vm_name`}}.box",
      "type": "vagrant",
      "only": ["virtualbox-iso"]
    }
  ]
}
